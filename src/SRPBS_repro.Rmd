---
title: "SRPB traveling subjects reproducibility analysis"
author: "Brian B. Avants"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

see 10.1016/j.jcm.2016.02.012

Cicchetti (1994)[19] gives the following often quoted guidelines for interpretation for kappa or ICC inter-rater agreement measures:

* Less than 0.40—poor.
* Between 0.40 and 0.59—fair.
* Between 0.60 and 0.74—good.
* Between 0.75 and 1.00—excellent.

A different guideline is given by Koo and Li (2016):

* below 0.50: poor
* between 0.50 and 0.75: moderate
* between 0.75 and 0.90: good
* above 0.90: excellent


```{r global options, include=FALSE}
library( knitr )
library( ANTsR )
library( ggplot2 )
require( grid )
require( gridExtra )
library( tidyr )
library( ggthemes )
library( ggthemr )
library( SimplyAgree )
library( subtyper )
theme_set(
    theme_classic(base_size = 25)
)
ggthemr("flat",text_size=20,spacing=1.3)
update_geom_defaults("point", list(size = 4))

```

> "if not now, when?"

see [this paper on resting state](https://www.sciencedirect.com/science/article/pii/S1053811919307487)


```{r readitsrpbs,echo=FALSE}
library(ANTsR)
rdir="/Users/stnava/code/antspymm_reproducibility/"
dd = read.csv( paste0( rdir, "/data/srpbs_participants.csv" ) )
# qct1 = read.table( paste0( rdir, "/data/srpbs_group_T1w.tsv" ), header = TRUE )
# qct1$participants_id=gsub("_T1w","",qct1$bids_name)
# qct1$participants_id=gsub("_run-01","",qct1$participants_id)
# dd = merge(dd,qct1,by='participants_id')
usubs = unique( dd$Subject )
usite = unique( dd$Site )
uscan = unique( dd$Scanner )

## pym data
pym = read.csv( paste0( rdir, "/data/srpbs_travel_antspymm.csv") )[,-c(1:2)]
sharesubs = intersect( dd$participants_id, pym$subjectID )
pym = pym[ pym$subjectID %in% sharesubs, ]
dd = dd[ dd$participants_id %in% sharesubs, ]
pym$participants_id = pym$subjectID
dd = merge( dd, pym, by='participants_id')

dd$outcome = dd[,'T1Hier_thk_right_precentraldktcortex']
dd$outcome = dd[,"rsfMRI_DefaultMode_2_DefaultMode"]
# dd = dd[ dd$Scanner != 'Signa' & dd$Site != 'KUT' & dd$T1Hier_resnetGrade >= 1.5, ]
dd = dd[ dd$Scanner != 'Signa' & dd$Site != 'KUT' & dd$Day == 1, ]
mdlSite = lm( T1Hier_resnetGrade ~ Site  + Subject , data=dd )

mdlScanner = lm( T1Hier_resnetGrade ~ Scanner + Subject, data=dd )

visreg::visreg( mdlSite )
visreg::visreg( mdlScanner )

```

Demonstrate effect of subject vs effect of Scanner or Site

```{r plotbysubject,fig.width=16,fig.height=16,eval=TRUE,echo=FALSE,message=FALSE}
library(GGally)
mycols = c('age', 'outcome', 'Site', 'Day','Phase','Manufacture','Coil','Scanner')
mycols = c('age', 'outcome', 'Site', 'Scanner')
nna = ! is.na( dd$outcome )
print(
  ggpairs(data = dd[nna, c('Subject',mycols)] ) )
#    mapping = ggplot2::aes_string(color = 'Subject'),
#        columns = mycols,
#        upper = list(continuous = "cor",
#                     combo = "box_no_facet",
#                     discrete = "facetbar",
#                     na = "na"),
#        lower = list(continuous = "points",
#                     combo = "facethist",
#                     discrete = "facetbar",
#                     na = "na"),
#        diag = list(continuous = "densityDiag",
#                    discrete = "barDiag",
#                    na = "naDiag"),
#        xlab = 'X',
#        ylab = 'Y',
#    title = 'Exploratory correlations:')


```

```{r gg2,fig.width=16,fig.height=5,echo=FALSE}
# ggthemr_reset()
# ggthemr("solarized",text_size=20,spacing=1.3)

set.seed(95)
random_colours <- sample(colors()[-c(1, 253, 361)], 12L)

# Define the custom palette
ugly <- define_palette(
    swatch = random_colours,
    gradient = c(lower = random_colours[1L], upper = random_colours[2L])
)

# Apply the custom palette
ggthemr(ugly)

ggplot(dd, aes(x = Subject, y = outcome, color = Site)) +
  geom_jitter(width=0.2,height=0.2) + ggtitle("Site")

```


```{r gg2site,fig.width=16,fig.height=5,echo=FALSE}
ggplot(dd, aes(x = Subject, y = outcome, color = Scanner)) +
  geom_jitter(width=0.2,height=0.2) + ggtitle("Scanner") #+geom_point(size=3)
```

What is the variability of the measurement if we control for age alone?
```{r statsage,fig.width=10,fig.height=4}
mdl=(lm( outcome ~  age + Subject , data=dd ))
visreg::visreg( mdl, "Subject", gg=TRUE )
```

What is the reproducibility of the measurement if we control for age and scanner?
```{r stats,fig.width=10,fig.height=4}

mdl=(lm( outcome ~  age + Subject + Scanner + 1 , data=dd ))
visreg::visreg( mdl, "Subject", gg=TRUE )
# grid.arrange( grobs = visreg::visreg( mdl, gg=TRUE ), ncol=1, main='reproducibility' )
```

What is the reproducibility of the measurement if we control for site?
```{r stats2c,fig.width=10,fig.height=4}

mdl=(lm( outcome ~  age + Subject + Site + 1 , data=dd ))
visreg::visreg( mdl, "Subject", gg=TRUE )

# grid.arrange( grobs = visreg::visreg( mdl, gg=TRUE ), ncol=1, main='reproducibility' )
```


What is the effect of age if we control for the best confounds?
```{r stats3age2,fig.width=10,fig.height=4}
library(lme4)
mdl=(lm( outcome ~  age  + Scanner + T1Hier_resnetGrade +(Subject), data=dd ))
# mdl=(lm( outcome ~  age   +(Subject), data=dd ))
visreg::visreg( mdl, 'age', gg=TRUE, main="t=-7.4 vs t=-5.6" )
```

```{r statsnorun,echo=FALSE,eval=FALSE,fig.width=10,fig.height=4}
qnms=names(dd)[13:80]
for ( qnm in qnms ) {
  mdl=(lm( paste0("outcome ~  age + Subject + Scanner + ", qnm) , data=dd ))
  mycoffs=coefficients(summary(mdl))
  if ( mycoffs[qnm,4] < 0.01 )  {
    print(mycoffs)
    print(visreg::visreg( mdl, qnm, gg=TRUE ))
  }
}
```


What is the reproducibility of the measurement if we control for motion?
```{r stats2,fig.width=10,fig.height=14}

mdl=(lm( outcome ~  age + Subject + Scanner + 1 , data=dd ))
grid.arrange( grobs = visreg::visreg( mdl, gg=TRUE ), ncol=1, main='reproducibility' )
```

show volumes for one subject at different sites

```{r onesub3bars,fig.width=17,fig.height=6,eval=FALSE}
nvols = length( roi$Description )
dfvols = data.frame( matrix( nrow=3, ncol=nvols+1) )
colnames(dfvols)=c("ID",roi$Description)
ct=0
for ( j in  c(86,88,93)) {
  myid = dd[j,"participants_id"]
  fn = paste0( rdir, "/SRPBTravel/", myid,
    "/T1wHierarchical/SRPBTravel-",myid,"-T1wHierarchical-bf.csv")
  if( file.exists( fn ) ) {
    roi = read.csv( fn )
    ct=ct+1
    dfvols[ct,] = c(j,roi$VolumeInMillimeters[])
    }
  }
dflong = pivot_longer( dfvols, names(dfvols)[-1] )
dflong$ID=factor(dflong$ID)
names(dflong)=c("ID","Anat","Volume")
ggplot(dflong, aes(fill=ID, y=Volume, x=Anat)) +
    geom_bar(position="dodge", stat="identity")+
      theme(text = element_text(size=22),
        axis.text.x = element_text(angle=0, hjust=1))
```


ICC(2,k) (Two-Way Random, Absolute Agreement, Average Measures): This version is used when the raters (or measurement devices) are considered random samples from a larger population of raters and you want to generalize your findings to this broader context. It's appropriate when different imaging sites might use different equipment or personnel, and you wish to assess the reliability of measurements across these variable conditions.

Both of these ICC types use the 'k' form, which means that the reliability is assessed based on the average of multiple measurements (in this case, multiple imaging sessions or sites), which generally provides a more robust and stable estimate of reliability.




Summmary  reliability data by Scanner

```{r}
print( reli_stats( "outcome", "Scanner", "Subject", data=dd ) )
```

Summmary  reliability data by Site

```{r}
print( reli_stats( "outcome", "Site", "Subject", data=dd ) )
```

Site-wise reliability

```{r,fig.width=12,fig.height=12,echo=FALSE}
library(irr)
myvar='Site'
# myvar='Scanner'
uscans=unique(dd[,myvar])
nVars=length(uscans)
iccdf = matrix(0,nrow=nVars,ncol=nVars)
uscansNam=uscans
for ( j in 1:nVars ) {
  ddscanj = dd[dd[,myvar]==uscans[j] & dd$Day==1,]
  uscansNam[j]=paste0(uscansNam[j],unique(ddscanj$Scanner))
}
rownames(iccdf)=uscansNam
colnames(iccdf)=uscansNam
for ( k in 1:nVars) {
  for (j in 1:nVars) {
  if ( TRUE) {
    subsloc =  intersect(
      dd[dd[,myvar]==uscans[k],"Subject"],
      dd[dd[,myvar]==uscans[j],"Subject"] )
    ddscanj = dd[dd[,myvar]==uscans[j] & dd$Day==1,]
    ddscank = dd[dd[,myvar]==uscans[k] & dd$Day==1,]
    sdf=data.frame(
      V0=ddscank[ ddscank[,"Subject"] %in% subsloc,"outcome"],
      V1=ddscanj[ ddscanj[,"Subject"] %in% subsloc,"outcome"] )
    iccSR = irr::icc( sdf[,c("V0","V1")],
      model = "oneway", type = "agreement", unit = "single" )$value # ,1,5)
    iccdf[k,j]=iccSR
    }
  }}#
# pheatmap::pheatmap(iccdf,display_numbers=T)
library(corrplot)
corrplot.mixed(iccdf,is.corr=F)
# corrplot::corrplot(iccdf, method = 'shade', order = 'AOE', diag = FALSE)
library("gplots")
heatmap.2(iccdf, scale = "none", col = bluered(100),
          trace = "none", density.info = "none")
```





Summmary  reliability data by Site

```{r setitup,echo=FALSE}
t1names = c( 
  getNamesFromDataframe( c("T1Hier_","vol",'dktcortex'), dd ),
  getNamesFromDataframe( c("T1Hier_","vol",'deep_cit'), dd ),
  getNamesFromDataframe( c("T1Hier_","thk",'dktcortex'), dd ),
  getNamesFromDataframe( c("T1Hier_","thk",'deep_cit'), dd ),
  getNamesFromDataframe( c("T1Hier_",'nbm','vol'), dd ),
  getNamesFromDataframe( c("T1Hier_",'nbm','thk'), dd ),
  getNamesFromDataframe( c("T1Hier_",'cerebellum','vol'), dd ),
  getNamesFromDataframe( c("T1Hier_",'mtl','vol'), dd ),
  getNamesFromDataframe( c("T1Hier_",'medulla','vol'), dd ),
  getNamesFromDataframe( c("T1Hier_",'midbrain','vol'), dd ),
  getNamesFromDataframe( c("T1Hier_",'pons','vol'), dd )
)
rsnames = getNamesFromDataframe( c("rsfMRI"), dd, exclusions=c('_alff','_falff','snr','evr','FD','dvars') )
rsnames = getNamesFromDataframe( c("rsfMRI"), dd, exclusions=c('_falff','snr','evr','FD','dvars') )
allnames = unique( c( t1names, rsnames ) )
dd = mapLRAverageVar( dd, allnames[grep("left",allnames)] )
allnames = gsub("left","LRAVG",allnames)
allnames = allnames[ -grep("right",allnames)]
mysam = sample( allnames, 5)
for ( outcome in mysam ) {
  print( reli_stats( outcome, item="Site", id="Subject", data=dd ) )
  print( outcome )
}
#######
```

Site-wise reliability

```{r somesortofcorrplot,fig.width=12,fig.height=12,echo=FALSE,eval=TRUE}
library(irr)
myvar='Site'
uscans=unique(dd[,myvar])
nVars=length(uscans)
usubs = unique( dd[,'Subject'] )
usubs = usubs[1:6]
nsubs = length( usubs )
iccdf = matrix(0,nrow=nsubs,ncol=nVars)
rownames(iccdf)=usubs
colnames(iccdf)=uscans
myiccs = data.frame( )
allnames=unique(allnames)
allnamesu = allnames[ grep("T1Hier_",allnames)]
# allnamesu = allnames[ grep("rsfMRI",allnames)]
#####################
for ( a in allnamesu ) {
  dd$outcome = dd[,a]
  for ( k in usubs) { 
    for (j in uscans) {
      sel = dd$Subject == k & dd$Site == j& dd$Day == 1
      if ( sum(sel,na.rm=T)== 1 )iccdf[k,j] = dd$outcome[ sel ]
    }
  }
  temp = psych::ICC(iccdf,lmer=FALSE)
  n = nrow( myiccs) + 1
  tempicc = as.numeric( temp$results['Average_raters_absolute','ICC'] )
  if ( tempicc < 0) tempicc=NA
  myiccs[n,c("anat",'icc')]=c(a,tempicc )
}
myiccs = myiccs[ !is.na( myiccs$icc ),]
mysam = sample( allnamesu, 6 )
mysam = myiccs$anat %in% mysam 
myiccsp = myiccs[mysam,]
myiccsp$anat = gsub("T1Hier_","",myiccsp$anat)
myiccsp$anat = gsub("rsfMRI_","",myiccsp$anat)
myiccsp$anat = gsub("TaskControl","",myiccsp$anat)
myiccsp$icc = as.numeric( myiccsp$icc )
myiccsp = myiccsp[ order( myiccsp$icc ), ]
print( myiccsp )
print(  ggpubr::ggbarplot( myiccsp, 'anat', 'icc', color='anat',fill='anat' )+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  )

# mykap = kappam.fleiss( iccdf, detail=TRUE )
# print( mykap )

```




# how many fall in each category 

```{r intepreticc,echo=FALSE,eval=TRUE,results='asis'}
library( kableExtra )

for ( k in 1:nrow(myiccs) ) {
  localicc = myiccs[k,'icc']
  myiccs[k,'Cicchetti']=interpret_icc( localicc, 'Cicchetti')
  myiccs[k,'Yoo']=interpret_icc( localicc, 'Yoo')
}

ccdf = data.frame( table( myiccs$Cicchetti )/sum( !is.na(myiccs$icc))  )
names(ccdf)[1]='Cicchetti'
ccdf=ccdf[ c( 
  which(ccdf[,1]=='Substantial'),
  which(ccdf[,1]=='Moderate'),
  which(ccdf[,1]=='Fair'),
  which(ccdf[,1]=='Slight')), ]
# kable_styling( kbl( ccdf , caption='Cicchetti criterion.') )
ccdf$Cicchetti = factor( ccdf$Cicchetti, levels = c("Substantial","Moderate","Fair","Slight"))

print( ggpubr::ggbarplot( ccdf, 'Cicchetti', 'Freq', color='Cicchetti',fill='Cicchetti' )+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  )


ccdf = data.frame( table( myiccs$Yoo )/sum( !is.na(myiccs$icc))  )
names(ccdf)[1]='Yoo'
ccdf=ccdf[ c( 
  which(ccdf[,1]=='Substantial'),
  which(ccdf[,1]=='Moderate'),
  which(ccdf[,1]=='Fair'),
  which(ccdf[,1]=='Slight')), ]
ccdf$Yoo = factor( ccdf$Yoo, levels = c("Substantial","Moderate","Fair","Slight"))
print( ggpubr::ggbarplot( ccdf, 'Yoo', 'Freq', color='Yoo',fill='Yoo' )+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  )

```


## which site is highest T1w quality

```{r hqt1,echo=FALSE}
library( emmeans )
mdl = lm( T1Hier_resnetGrade ~ Site , dd)
visreg::visreg( mdl, 'Site')
myem = data.frame( emmeans( mdl, 'Site' ) )
bestsite = myem$Site[ which.max( myem$emmean ) ]
bestsite1 = myem$Site[ order( myem$emmean, decreasing=T )[1] ]
bestsite2 = myem$Site[ order( myem$emmean, decreasing=T )[2] ]
bestsite3 = myem$Site[ order( myem$emmean, decreasing=T )[3] ]
bestsite4 = myem$Site[ order( myem$emmean, decreasing=T )[4] ]
```

## SiMLR TRT 

```{r simlrtrtTrain,echo=FALSE}
lrt1 = getNamesFromDataframe( c("T1Hier","LRAV"), dd )
rsfc = getNamesFromDataframe( c("rsfMRI","_2_"), dd )
sitesel = dd$Site == bestsite
m1 = dd[ sitesel , lrt1 ]
m2 = dd[ sitesel , rsfc ]
matlist = list(t1=scale(m1,T,T),rsf=scale(m2,T,T))
regs = regularizeSimlr( matlist, fraction=0.1, sigma=c(1.0,1.0) )
###########
myjr = TRUE
# myjr = F
prescaling = c( 'centerAndScale', 'sqrtnp' )
optimus = 'lineSearch'
maxits = 100
ebber = 0.99
quantval = 0.5
pizzer = c( "positive", "positive" )
objectiver = 'cca' ; mixer = 'pca'
objectiver = 'regression' ; mixer = 'ica'
sparval = c( 0.8, 0.8 ) 
##########
nsimlr = 5
initu = initializeSimlr(
                    matlist,
                    nsimlr,
                    jointReduction = myjr,
                    zeroUpper = FALSE,
                    uAlgorithm = "pca",
                    addNoise = 0 )

simlrX = simlr( matlist, 
                        regs, 
                        iterations=maxits, 
                        verbose=T,
                        randomSeed = 0,
                        mixAlg=mixer,
                        energyType=objectiver,
                        scale = prescaling,
                        sparsenessQuantiles=sparval,
                        positivities = pizzer, expBeta=ebber,
                        optimizationStyle=optimus,
                        initialUMatrix=initu )
simlrpred1a = predictSimlr( matlist, simlrX, 
                    targetMatrix=2, sourceMatrices=1 )
simlrpred1b = predictSimlr( matlist, simlrX, 
                    targetMatrix=1, sourceMatrices=2 )
print( simlrpred1a$varx )             
print( simlrpred1b$varx )             
######
```




```{r simlrtrtTest,echo=FALSE}
ee = dd[ dd$Subject %in% usubs , ]
sitetrtsimlr=data.frame()
for ( jj in 1:length(usite)) {
  bestsitex = usite[jj]
  sitesel = subtyper::fs( ee$Site == bestsitex )
  lsubs = ee[ sitesel, 'Subject' ]
  t1 = ee[ sitesel , lrt1 ]
  rsf = ee[ sitesel , rsfc ]
  if ( nrow( m1 ) > 0 ) {
    if ( FALSE ) {
      matlist2 = list(t1=(scale(t1,T,T)),rsf=(scale(rsf,T,T)))
      if ( sum(is.na(matlist2[[1]]))==0 & sum(is.na(matlist2[[2]]))==0 ) {
        simlrpred2a = predictSimlr( matlist2, simlrX, 
                            targetMatrix=2, sourceMatrices=1 )
        simlrpred2b = predictSimlr( matlist2, simlrX, 
                            targetMatrix=1, sourceMatrices=2 )
        print( paste( jj, bestsitex, simlrpred2a$varx, simlrpred2b$varx ) )
        sitetrtsimlr[jj,'site']=bestsitex
        sitetrtsimlr[jj,'varx1']=simlrpred2a$varx
        sitetrtsimlr[jj,'varx2']=simlrpred2b$varx
      }
    } else {
      proj1=data.frame(
        Subject = lsubs,
        t1=data.matrix(t1) %*% simlrX$v[[1]], 
        rsf=data.matrix(rsf) %*% simlrX$v[[2]], 
        Site=rep(bestsitex,nrow(t1)))
      if ( jj == 1 ) sitetrtsimlr=proj1 else sitetrtsimlr=rbind(sitetrtsimlr,proj1)
    }
  }
}
######

outcomes = getNamesFromDataframe( 'PC', sitetrtsimlr)
for ( outcome in outcomes ) {
  mick = reli_stats( outcome, item="Site", id="Subject", data=sitetrtsimlr )
  print( paste( outcome, mick$icc[5,'icc'] ) )
}

```




```{r braindead,eval=FALSE,echo=FALSE}
voi = getNamesFromDataframe( c("T1Hier_","vol",'temporal','superior','LRAVG'), dd)
cordf=matrix( nrow=length(usite),ncol=length(usite))
for ( jj in 1:length(usite)) {
  v0 = dd[ dd$Site == usite[jj], voi ]
  for ( kk in 1:length(usite)) {
    v1 = dd[ dd$Site == usite[kk], voi ]
    if (length(v1) == length(v0) && jj != kk & length(v1) > 0 ) {
      iccdf <- data.frame(v0, v1)
      icc_result0 = psych::ICC(iccdf)
      icc_result <- icc_result0$result$ICC[1]
      # print( paste(jj,kk,cor(v0,v1)))
      cordf[jj,kk]=icc_result
    }
  }
}
print( mean(cordf,na.rm=T) )


```