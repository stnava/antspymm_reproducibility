---
title: "DTI traveling subjects reproducibility analysis"
author: "Brian B. Avants"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---



* we use data from a traveling subject DTI cohort [(here)](https://doi.org/10.1016/j.mri.2019.02.011)

  * a traveling cohort : 3 healthy subjects travel to 4 sites to be imaged

  * sites represent variability in both MRI manufacturer and MRI model (high variability)

* this enables us to investigate the reliability of our imaging-derived phenotypes (IDPs)

  * IDPs computed with ANTsPyMM (latest version)

  * we use the intraclass correlation coefficient (ICC) to assess consistency or reproducibility of the quantitative IDPs

* the majority of IDPs show superior reliability 

  * joint reduction of IDPs with SiMLR improves reliability further


**ANTsPyMM IDPs derived from the same subjects imaged at different sites with MRI from various manufacturers show overall high reliability.**  This provides empirical evidence that multiple modality MRI may be used to derive quantitative phenotypes on which predictive models may be based.

```{r global options, include=FALSE}
library( knitr )
library( ANTsR )
library( ggplot2 )
require( grid )
require( gridExtra )
library( tidyr )
library( ggthemes )
library( ggthemr )
library( SimplyAgree )
library( subtyper )
theme_set(
    theme_classic(base_size = 25)
)
ggthemr("flat",text_size=20,spacing=1.3)
update_geom_defaults("point", list(size = 4))


brewpal = 'Pastel1'
brewpal = 'Set3'
icck <- function( indf, outcome  ) {
#  mick = reli_stats( outcome, item="Site", id="Subject", data=indf )
  mick = reli_aov( outcome, item="Site", id="Subject", data=indf )
  # print( paste( outcome, mick$icc[5,'icc'] ) )
  return(  mick$icc[5,'icc'] )
}

```


```{r readitdti,echo=FALSE}
library(ANTsR)
rdir="/Users/stnava/code/antspymm_reproducibility/"
if ( ! exists("dd") ) {
  demog = read.csv(paste0(rdir,"data/dti_travel_participants.csv"))
  dd = read.csv(paste0(rdir,'data/dti_travel_antspymm.csv'))[,-c(1:2)]
  names(dd)[3]='Site'
  dd$participant_id = dd$subjectID
  dd = merge( dd, demog, by='participant_id')
  dd$Subject = dd$participant_id
}

mycc = getNamesFromDataframe( c('mean_fa', 'allosum'), dd )
dd$outcome = dd[,mycc[1]]

mdlSite = lm( T1Hier_resnetGrade ~ Site  + Subject , data=dd )
visreg::visreg( mdlSite, 'Site' )

```

Demonstrate effect of subject vs effect of Scanner or Site

```{r plotbysubject,fig.width=16,fig.height=16,eval=TRUE,echo=FALSE,message=FALSE}
library(GGally)
mycols = c('age', 'outcome', 'Site' )
nna = ! is.na( dd$outcome )
print(
  ggpairs(data = dd[nna, c('Subject',mycols)] ) )
#    mapping = ggplot2::aes_string(color = 'Subject'),
#        columns = mycols,
#        upper = list(continuous = "cor",
#                     combo = "box_no_facet",
#                     discrete = "facetbar",
#                     na = "na"),
#        lower = list(continuous = "points",
#                     combo = "facethist",
#                     discrete = "facetbar",
#                     na = "na"),
#        diag = list(continuous = "densityDiag",
#                    discrete = "barDiag",
#                    na = "naDiag"),
#        xlab = 'X',
#        ylab = 'Y',
#    title = 'Exploratory correlations:')


```

```{r gg2,fig.width=16,fig.height=5,echo=FALSE}
# ggthemr_reset()
ggthemr("fresh",text_size=20,spacing=1.3)
ggplot(dd, aes(x = Subject, y = outcome, color = Site)) +
  geom_jitter(width=0.2,height=0.2) + ggtitle("Site")

```


What is the variability of the measurement if we control for age alone?
```{r statsage,fig.width=10,fig.height=4}
mdl=(lm( outcome ~  age + Subject , data=dd ))
visreg::visreg( mdl, "Subject", gg=TRUE )
```


What is the reproducibility of the measurement if we control for noise?
```{r stats2c,fig.width=10,fig.height=4}

mdl=(lm( outcome ~  age + Subject + Site + DTI_dti_tsnr_b0_mean , data=dd ))
visreg::visreg( mdl, "Subject", gg=TRUE )

# grid.arrange( grobs = visreg::visreg( mdl, gg=TRUE ), ncol=1, main='reproducibility' )
```



What is the effect of gray matter resnetGrade?
```{r stats3,fig.width=10,fig.height=4}

mdl=(lm( outcome ~  age + Subject + Site + T1Hier_resnetGrade , data=dd ))
visreg::visreg( mdl, 'Site', gg=TRUE )
```



What is the effect of age if we control for the best confounds?
```{r stats3age2,fig.width=10,fig.height=4}
library(lme4)
mdl=(lm( outcome ~  age  + DTI_dti_tsnr_b0_mean+ Site + T1Hier_resnetGrade +(Subject), data=dd ))
# mdl=(lm( outcome ~  age   +(Subject), data=dd ))
visreg::visreg( mdl, 'age', gg=TRUE, main="FIXME" )
```


What is the reproducibility of the measurement if we control for motion?
```{r stats2,fig.width=10,fig.height=14,eval=FALSE}

mdl=(lm( outcome ~ Subject + DTI_dti_tsnr_b0_mean + DTI_dti_FD_mean, data=dd ))
grid.arrange( grobs = visreg::visreg( mdl, 'Subject', gg=TRUE ), ncol=1, main='reproducibility' )


```

try mixed models to estimate icc

```{r lme4icc,echo=FALSE,eval=FALSE}
library(lme4)
# Assuming you have a data frame 'df' with a measurement variable 'measurement',
# and a grouping variable 'subject'

# Fit a mixed-effects model (random intercepts model)
model <- lmer(outcome ~  (1 | Site), data = dd)

# Extract variance components
var_comp <- VarCorr(model)

# Calculate the ICC
# Total variance is the sum of subject variance and residual variance
subject_variance <- var_comp$subject[1]
residual_variance <- attr(var_comp, "sc")^2
icc <- subject_variance / (subject_variance + residual_variance)

print(icc)
```


ICC(2,k) (Two-Way Random, Absolute Agreement, Average Measures): This version is used when the raters (or measurement devices) are considered random samples from a larger population of raters and you want to generalize your findings to this broader context. It's appropriate when different imaging sites might use different equipment or personnel, and you wish to assess the reliability of measurements across these variable conditions.

Both of these ICC types use the 'k' form, which means that the reliability is assessed based on the average of multiple measurements (in this case, multiple imaging sessions or sites), which generally provides a more robust and stable estimate of reliability.




Summmary  reliability data by Site

```{r deeeeee,echo=FALSE}
t1names = c( 
  getNamesFromDataframe( c("T1Hier_","vol",'dktcortex'), dd ),
  getNamesFromDataframe( c("T1Hier_","vol",'deep_cit'), dd )
)
dtnames = c( 
  getNamesFromDataframe( c("DTI_mean_fa"), dd ) )
allnames = unique( c( t1names, dtnames ) )
dd = mapLRAverageVar( dd, allnames[grep("left",allnames)] )
allnames = gsub("left","LRAVG",allnames)
allnames = allnames[ -grep("could",allnames)]
allnames = allnames[ -grep("_and_",allnames)]
allnames = allnames[ -grep("unclass",allnames)]
allnames = allnames[ -grep("backgr",allnames)]
allnameslen = rep(0,length(allnames))
for ( k in 1:length(allnames))allnameslen[k]=nchar(allnames[k])
allnames = allnames[ allnameslen < 50 ]
allnames = allnames[ -grep("right",allnames)]
mysam = sample( allnames, 5)
for ( outcome in mysam ) {
  print( reli_stats( outcome, item="Site", id="Subject", data=dd ) )
  print( outcome )
}
#######
```

Site-wise reliability

```{r somesortofcorrplot,fig.width=12,fig.height=12,echo=FALSE,eval=TRUE}
library(irr)
myvar='Site'
uscans=unique(dd[,myvar])
nVars=length(uscans)
usubs = unique( dd[,'Subject'] )
nsubs = length( usubs )
iccdf = matrix(0,nrow=nsubs,ncol=nVars)
rownames(iccdf)=usubs
colnames(iccdf)=uscans
myiccs = data.frame( )
allnames=unique(allnames)
# allnames=allnames[grep("DTI",allnames)]
#####################
for ( a in allnames ) {
  dd$outcome = dd[,a]
  for ( k in usubs) { 
    for (j in uscans) {
      iccdf[k,j] = dd$outcome[ dd$Subject == k & dd$Site == j ]
    }
  }
  temp = psych::ICC(iccdf,lmer=FALSE)
  n = nrow( myiccs) + 1
  tempicc = as.numeric( temp$results['Average_raters_absolute','ICC'] )
  if ( tempicc < 0) tempicc=NA
  myiccs[n,c("anat",'icc')]=c(a,tempicc )
}
myiccs$icc = as.numeric( myiccs$icc )
myiccs = myiccs[ !is.na( myiccs$icc ),]
mysam = sample( allnames, 8 )
mysam = myiccs$anat %in% mysam 
myiccsp = myiccs[mysam,]
myiccsp$anat = gsub("DTI_mean_fa_","fa_",myiccsp$anat)
myiccsp$anat = gsub("jhu_icbm_labels_1mm", "",myiccsp$anat)
myiccsp$anat = gsub("[.]","",myiccsp$anat)
myiccsp$anat = gsub("T1Hier_","",myiccsp$anat)
myiccsp$anat = gsub("LRAVG","",myiccsp$anat)
myiccsp$anat = gsub("__","_",myiccsp$anat)
myiccsp$icc = as.numeric( myiccsp$icc )
myiccsp = myiccsp[ order( myiccsp$icc ), ]
print( myiccsp )
print( ggpubr::ggbarplot( myiccsp, 'anat', 'icc', color='anat',fill='anat' )+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  )


# mykap = kappam.fleiss( iccdf, detail=TRUE )
# print( mykap )

```


# how many fall in each category 

```{r intepreticc,echo=FALSE,eval=TRUE}
library( kableExtra )

for ( k in 1:nrow(myiccs) ) {
  localicc = myiccs[k,'icc']
  myiccs[k,'Cicchetti']=interpret_icc( localicc, 'Cicchetti')
  myiccs[k,'Koo']=interpret_icc( localicc, 'Koo')
}

ccdf = data.frame( table( myiccs$Cicchetti )/sum( !is.na(myiccs$icc))  )
names(ccdf)[1]='Cicchetti'
ccdf=ccdf[ c( 
  which(ccdf[,1]=='Substantial'),
  which(ccdf[,1]=='Moderate'),
  which(ccdf[,1]=='Fair'),
  which(ccdf[,1]=='Slight')), ]
# kable_styling( kbl( ccdf , caption='Cicchetti criterion.') )
ccdf$Cicchetti = factor( ccdf$Cicchetti, levels = c("Substantial","Moderate","Fair","Slight"))

print( ggpubr::ggbarplot( ccdf, 'Cicchetti', 'Freq', color='Cicchetti',fill='Cicchetti' )+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  )


ccdf = data.frame( table( myiccs$Koo )/sum( !is.na(myiccs$icc))  )
names(ccdf)[1]='Koo'
ccdf=ccdf[ c( 
  which(ccdf[,1]=='Substantial'),
  which(ccdf[,1]=='Moderate'),
  which(ccdf[,1]=='Fair'),
  which(ccdf[,1]=='Slight')), ]
ccdf$Koo = factor( ccdf$Koo, levels = c("Substantial","Moderate","Fair","Slight"))
print( ggpubr::ggbarplot( ccdf, 'Koo', 'Freq', color='Koo',fill='Koo' )+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  )

# kable_styling( kbl( ccdf , caption='Koo criterion.') )

```




# this is "the same" as the SRPBS analysis


Site-wise reliability

```{r somesortofcorrplot2,fig.width=8,fig.height=8,echo=FALSE,eval=TRUE}
library(irr)
myvar='Site'
uscans = unique(dd[,myvar])
nVars = length(uscans)
usubs = sort( unique( dd[,'Subject'] ) )
nsubs = length( usubs )
iccdf = matrix(0,nrow=nsubs,ncol=nVars)
rownames(iccdf)=usubs
colnames(iccdf)=uscans
allnames=unique(allnames)
allnamesu = allnames # [ grep("DTI",allnames)]
#####################
ee = dd[  dd$Subject %in% usubs, ]
myiccs = data.frame( )
for ( a in allnamesu ) {
  n = nrow( myiccs) + 1
  tempicc = icck( ee, a )
  myiccs[n,c("anat",'icc')]=c(a,tempicc )
}
myiccs$icc = as.numeric( myiccs$icc )
myiccs = myiccs[ !is.na( myiccs$icc ) & myiccs$icc > 0,]
mysam = sample( allnamesu, 6 )
mysam = myiccs$anat %in% mysam 
myiccsp = myiccs[mysam,]
myiccsp$anat = gsub("DTI_mean_fa_","fa_",myiccsp$anat)
myiccsp$anat = gsub("jhu_icbm_labels_1mm", "",myiccsp$anat)
myiccsp$anat = gsub("[.]","",myiccsp$anat)
myiccsp$anat = gsub("T1Hier_","",myiccsp$anat)
myiccsp$anat = gsub("LRAVG","",myiccsp$anat)
myiccsp$anat = gsub("__","_",myiccsp$anat)
myiccsp$icc = as.numeric( myiccsp$icc )
myiccsp = myiccsp[ order( myiccsp$icc ), ]
print( myiccsp )
print(  ggpubr::ggbarplot( myiccsp, 'anat', 'icc', color='anat',fill='anat', palette=brewpal )+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) )

# mykap = kappam.fleiss( iccdf, detail=TRUE )
# print( mykap )
```


## how does site impact image quality 


* higher scores are better 

* a few sites are lower quality 

* a few subjects exhibit lower quality (consistently)

```{r hqt1,echo=FALSE,fig.width=10,fig.height=5}
library( emmeans )
ggpubr::ggboxplot(dd, y = "T1Hier_resnetGrade", x='Site',
   color = "Site", # fill = "anat",
   palette = 'Set1', title='Image quality variability by site' )+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
cat(
  "\n\n\n\n\n\n"
)
ggpubr::ggboxplot(dd, y = "T1Hier_resnetGrade", x='Subject',
   color = "Subject", # fill = "anat",
   palette = 'Set1', title='Image quality variability by subject' )+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))

mdl = lm( T1Hier_resnetGrade ~ Site , dd)
myem = data.frame( emmeans( mdl, 'Site' ) )
goodsites = usite = myem$Site[ order( myem$emmean, decreasing=T ) ]
```

## raw ICC for ROI representation

```{r boxplotroi,fig.width=8,fig.height=4,echo=FALSE,eval=TRUE}

myiccs$icc = as.numeric( myiccs$icc )
myiccs = myiccs[ myiccs$icc > 0, ]
myiccs$modality='t1'
myiccs$modality[ grep("DTI",myiccs$anat)]='DTI'
ggpubr::ggboxplot(myiccs, y = "icc", x='modality',
   color = "modality", # fill = "anat",
   palette = 'Dark2', title='ICC variability by modality for ROI representation' )+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))

```


# how many ROIs fall in each category of ICC

```{r intepreticc2,echo=FALSE,eval=TRUE,results='asis'}
library( kableExtra )

for ( k in 1:nrow(myiccs) ) {
  localicc = myiccs[k,'icc']
  myiccs[k,'Cicchetti']=interpret_icc( localicc, 'Cicchetti')
  myiccs[k,'Koo']=interpret_icc( localicc, 'Koo')
}
ilevs = c("Substantial","Moderate","Fair","Slight")

ccdf = data.frame( table( myiccs$Cicchetti )/sum( !is.na(myiccs$icc))  )
names(ccdf)[1]='Cicchetti'
ccdf=ccdf[ c( 
  which(ccdf[,1]==ilevs[1]),
  which(ccdf[,1]==ilevs[2]),
  which(ccdf[,1]==ilevs[3]),
  which(ccdf[,1]==ilevs[4])), ]
# kable_styling( kbl( ccdf , caption='Cicchetti criterion.') )
ccdf$Cicchetti = factor( ccdf$Cicchetti, levels = ilevs )

print( ggpubr::ggbarplot( ccdf, 'Cicchetti', 'Freq', color='Cicchetti',fill='Cicchetti',palette=brewpal, title='ROI ICC: Cicchetti interpretation' )+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  )


ccdf = data.frame( table( myiccs$Koo )/sum( !is.na(myiccs$icc))  )
names(ccdf)[1]='Koo'
ccdf=ccdf[ c( 
  which(ccdf[,1]==ilevs[1]),
  which(ccdf[,1]==ilevs[2]),
  which(ccdf[,1]==ilevs[3]),
  which(ccdf[,1]==ilevs[4])), ]
ccdf$Koo = factor( ccdf$Koo, levels = ilevs )
print( ggpubr::ggbarplot( ccdf, 'Koo', 'Freq', color='Koo',fill='Koo', palette=brewpal, title='ROI ICC: Koo interpretation')+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  )

```


## Do SiMLR-derived IDPs improve reliability?  training testing paradigm across sites

* train simlr on each of top quality sites

  * association of T1-derived IDPs and DTI IDPs 

  * default parameters for SiMLR (regression and ICA)

* test on each other site 

  * just means projecting the IDPs onto the SiMLR bases for both T1 and DTI

* this lets us look at ICC in the simlr space 

  * shows that SiMLR latent space (generally) improves ICC over raw ROI representation

```{r simlrtrtTrain,echo=FALSE}
myiccsimlr = data.frame()
rm( initu )
# for ( siteonwhichtotrain in c(bestsite1,bestsite2,bestsite3,bestsite4) ) {
for ( siteonwhichtotrain in goodsites ) {
  print( paste("USE SITE: ", siteonwhichtotrain ))
  lrt1 = getNamesFromDataframe( c("T1Hier","LRAV"), ee )
  dtivars = getNamesFromDataframe( c("DTI","LRA"), ee, exclusions='cnx' )
  sitesel = ee$Site == siteonwhichtotrain
  m1 = ee[ sitesel , lrt1 ]
  m2 = ee[ sitesel , dtivars ]
  matlist = list(t1=scale(m1,T,T),rsf=antsrimpute(scale(m2,T,T)))
  regs = list() # regularizeSimlr( matlist, fraction=0.1, sigma=c(1.0,1.0) )
  for ( j in 1:length(matlist))
    regs[[j]] = diag( ncol( matlist[[j]]) )
  ###########
  myjr = TRUE
  # myjr = F
  prescaling = c( 'centerAndScale', 'sqrtnp' )
  optimus = 'lineSearch'
  maxits = 100
  ebber = 0.99
  quantval = 0.5
  pizzer = c( "positive", "positive" )
  objectiver = 'cca' ; mixer = 'pca'
  objectiver = 'regression' ; mixer = 'ica'
  sparval = c( 0.8, 0.8 ) 
  ##########
  nsimlr = 2 # nrow(matlist[[1]]) - 1
  nsimlr = nrow(matlist[[1]])
  if ( ! exists( "initu" )  )
    initu = initializeSimlr(
                      matlist,
                      nsimlr,
                      jointReduction = myjr,
                      zeroUpper = FALSE,
                      uAlgorithm = "pca",
                      addNoise = 0 )
  simlrX = simlr( matlist, 
                          regs, 
                          iterations=maxits, 
                          verbose=FALSE,
                          randomSeed = 0,
                          mixAlg=mixer,
                          energyType=objectiver,
                          scale = prescaling,
                          sparsenessQuantiles=sparval,
                          positivities = pizzer, expBeta=ebber,
                          optimizationStyle=optimus,
                          initialUMatrix=initu )
  sitetrtsimlr=data.frame()
  for ( jj in 1:length(usite)) {
    bestsitex = usite[jj]
    sitesel = subtyper::fs( ee$Site == bestsitex )
    lsubs = ee[ sitesel, 'Subject' ]
    t1 = ee[ sitesel , lrt1 ]
    rsf = ee[ sitesel , dtivars ]
    proj1=data.frame(
          Subject = lsubs,
          t1=data.matrix(t1) %*% simlrX$v[[1]], 
          DTI=data.matrix(rsf) %*% simlrX$v[[2]], 
          Site=rep(bestsitex,nrow(t1)))
    if ( jj == 1 ) sitetrtsimlr=proj1 else sitetrtsimlr=rbind(sitetrtsimlr,proj1)
    }
  ######
  outcomes = getNamesFromDataframe( 'PC', sitetrtsimlr)
  for ( outcome in outcomes ) {
    n = nrow( myiccsimlr) + 1
    tempicc = icck( sitetrtsimlr, outcome )
    myiccsimlr[n,c("anat",'icc')]=c(outcome, tempicc )
    myiccsimlr[n,'Cicchetti']=interpret_icc( tempicc, 'Cicchetti')
    myiccsimlr[n,'Koo']=interpret_icc( tempicc, 'Koo')
    myiccsimlr[n,'trainsite']=siteonwhichtotrain
  }
  myiccsimlr$icc = as.numeric( myiccsimlr$icc )
  #############################################
}
#################################################
```

## raw simlr ICC values 

```{r simlriccvalues,echo=FALSE,eval=TRUE,fig.width=8,fig.height=4}
ss = myiccsimlr$icc >= 0
myiccsimlr = myiccsimlr[ss,]
myiccsimlr$icc = as.numeric( myiccsimlr$icc )
myiccsimlr$modality='t1'
myiccsimlr$modality[ grep("DTI",myiccsimlr$anat)]='DTI'
ggpubr::ggboxplot(myiccsimlr, y = "icc", x='modality',
   color = "modality", # fill = "anat",
   palette = 'Dark2', title='ICC variability by modality for SiMLR representation' )+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))

```

## simlr ICC interpretation 

```{r simlriccinterp,echo=FALSE,eval=TRUE,results='asis'}
ccdf = data.frame( table( myiccsimlr$Cicchetti )/sum( !is.na(myiccsimlr$icc))  )
names(ccdf)[1]='Cicchetti'
ccdf=ccdf[ c( 
  which(ccdf[,1]==ilevs[1]),
  which(ccdf[,1]==ilevs[2]),
  which(ccdf[,1]==ilevs[3]),
  which(ccdf[,1]==ilevs[4])), ]
# kable_styling( kbl( ccdf , caption='Cicchetti criterion.') )
ccdf$Cicchetti = factor( ccdf$Cicchetti, levels = ilevs )

print( ggpubr::ggbarplot( ccdf, 'Cicchetti', 'Freq', color='Cicchetti',fill='Cicchetti',palette=brewpal, title='SiMLR ICC: Cicchetti interpretation' )+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  )

cat("\n\n\n")

ccdf = data.frame( table( myiccsimlr$Koo )/sum( !is.na(myiccsimlr$icc))  )
names(ccdf)[1]='Koo'
ccdf=ccdf[ c( 
  which(ccdf[,1]==ilevs[1]),
  which(ccdf[,1]==ilevs[2]),
  which(ccdf[,1]==ilevs[3]),
  which(ccdf[,1]==ilevs[4])), ]
ccdf$Koo = factor( ccdf$Koo, levels = ilevs)
print( ggpubr::ggbarplot( ccdf, 'Koo', 'Freq', color='Koo',fill='Koo', palette=brewpal, title='SiMLR ICC: Koo interpretation')+theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  )
```



## simple t-test between two representations 

```{r tt,echo=FALSE,eval=TRUE}
t1sel1=myiccs$modality == 't1'
t1sel2=myiccsimlr$modality == 't1'
print("T-test of SiMLR vs ROI representation: T1 IDPs")
print( t.test( myiccsimlr[t1sel2,'icc'], myiccs[t1sel1,'icc'],  paired=FALSE ) )

rssel1=myiccs$modality == 'DTI'
rssel2=myiccsimlr$modality == 'DTI' # 
print("T-test of SiMLR vs ROI representation: DTI IDPs")
print( t.test( myiccsimlr[rssel2,'icc'], myiccs[rssel1,'icc'],  paired=FALSE ) )

```


## Summary tabSimlr vs ROIs: ICC IDP reliability in T1w

```{r boxplotttT1,fig.width=8,fig.height=4,echo=FALSE,eval=TRUE}

rssel1=myiccs$modality == 't1'
rssel2=myiccsimlr$modality == 't1' # 
temp1 = myiccsimlr[rssel2,]
temp1$method='tabSiMLR'
temp2 = myiccs[rssel1,]
temp2$method='ROI'
cnames = intersect( colnames(temp1), colnames(temp2))
temp = rbind( 
temp1[,cnames],
temp2[,cnames]
)
ggpubr::ggboxplot(temp, y = "icc", x='method',
   color = "method", # notch=TRUE, # fill = "anat",
   palette = 'npg', title='ICC variability by method: T1w IDPs' )+ 
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1))

```


## Summary tabSimlr vs ROIs: ICC IDP reliability in DTI


```{r boxplotttdti,fig.width=8,fig.height=4,echo=FALSE,eval=TRUE}

rssel1=myiccs$modality == 'DTI'
rssel2=myiccsimlr$modality == 'DTI' # 
temp1 = myiccsimlr[rssel2,]
temp1$method='tabSiMLR'
temp2 = myiccs[rssel1,]
temp2$method='ROI'
cnames = intersect( colnames(temp1), colnames(temp2))
temp = rbind( 
temp1[,cnames],
temp2[,cnames]
)
ggpubr::ggboxplot(temp, y = "icc", x='method',
   color = "method", # notch=TRUE, # fill = "anat",
   palette = 'npg', title='ICC variability by method: DTI IDPs' )+ 
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1))

```


